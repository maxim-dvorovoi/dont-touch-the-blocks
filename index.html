<!DOCTYPE html>
<html>
<head>
	<title>Flappy Bird</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>
<body class="unselectable">
	<div class="field">
		<div class="field" id="field" class="unselectable">
			<img class="bird" src="./img/bird.png" id="bird">
		</div>
		<div class="popup" id="popup">
			<p>
				<span class="button" id="start" >START</span>
			</p>
		</div>
	</div>

	<p><span id="score"></span></p>

	<script type="text/javascript">
		let reverse = false;
		let popupEnable = false;
		let end = false;
		let clickCount = 0;
		let score = 0;
		let width = 350;
		showHidePopup();

		start.onclick = function(event) {
			score = 0;
			end = true;
			reverse = false;
			let height = field.clientHeight - bird.clientHeight;
			bird.style.transform = 'scale(1, 1)';
			setScore();
			showHidePopup();

			animate({
				duration: 2000,
				timing: makeEaseOut(bounce),
				draw: function(progress) {
					bird.style.top = height * progress + 'px';
				}
			});

			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					bird.style.left = width * progress + "px";
				}
			});
		};

		field.onclick = function(event) {
			if (popupEnable) return;

			end = false;
			let startTop = Number.parseInt(bird.style.top.substring(0,  bird.style.left.length - 2));
			let startLeft = Number.parseInt(bird.style.left.substring(0,  bird.style.left.length - 2));

			let height = field.clientHeight - bird.clientHeight;
			let currentClick = ++clickCount;

			animate({
				duration: 1000,
				timing: makeInOut(jump),
				draw: function(progress) {
					if (end || currentClick !== clickCount) return;
					let top = startTop + height * progress;

					if (top > 435 || top < 0) showHidePopup();

					bird.style.top = (top > 435 ? 435 : (top < 0 ? 0 : top)) + 'px';
				}
			});

			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					if (end || currentClick !== clickCount) return;
					if (progress < 0) progress = 0;

					let left = startLeft + width * progress * (reverse === true ? -1 : 1);

					if (left > 750 || left < 0) {
						reverse = !reverse;
						left = left > 750 ? 750 : (left < 0 ? 0 : left);
						startLeft = left + (left - startLeft);
						++score;
						setScore();
					}

					bird.style.transform = 'scale(' + (reverse ? -1 : 1) + ', 1)';
					bird.style.left = left + "px";
				}
			});
		};

		function showHidePopup() {
			setScore();
			popupEnable = !popupEnable;
			popup.style.opacity = (popup.style.opacity == '1' ? '0' : '1');
			popup.style.zIndex = (popup.style.zIndex == '1' ? '-1' : '1');
			field.style.opacity = (popup.style.opacity == '1' ? '0.5' : '1');
		}

		function setScore() {
			document.getElementById('score').innerHTML = 'SCORE: ' + score;
		}
		
		function jump(timeFraction) {
			return  Math.pow(timeFraction*1.2, 2) * (2.2 * (timeFraction + 0.1) - 1.7)
		}
		
		function makeInOut(timing) {
			return function(timeFraction) {
				return timing(timeFraction);
			}
		}
		
		function makeEaseOut(timing) {
			return function(timeFraction) {
				return 1 - timing(1 - timeFraction);
			}
		}

		function bounce(timeFraction) {
			for (let a = 0, b = 1, result; 1; a += b, b /= 2) {
				if (timeFraction >= (7 - 4 * a) / 11) {
					return -Math.pow((11 - 6 * a - 11 * timeFraction) / 4, 2) + Math.pow(b, 2)
				}
			}
		}
		
		function quad(timeFraction) {
			return timeFraction;
		}
		
		function animate(options) {
			let start = performance.now();

			requestAnimationFrame(function animate(time) {
				let timeFraction = (time - start) / options.duration;
				if (timeFraction > 1) timeFraction = 1;

				let progress = options.timing(timeFraction);
				options.draw(progress);

				if (timeFraction < 1) requestAnimationFrame(animate);
			});
		}
	</script>
</body>
</html>