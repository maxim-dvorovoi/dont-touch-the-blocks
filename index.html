<!DOCTYPE html>
<html>
<head>
	<title>Flappy Bird</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
</head>
<body class="unselectable" onload="setTimeout(showPage, 1000)">
	<div id="loader" class="loader">
		<div class="center">
			<div class="dot-1"></div>
			<div class="dot-2"></div>
			<div class="dot-3"></div>
		</div>
	</div>

	<div style="display:none" id="index"  class="animate-bottom">
		<div class="field mtop-40">
			<div class="field" id="field" class="unselectable">
				<img class="bird" src="./img/bird.png" id="bird">

				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>
				<div class="triangle-down"></div>

				<div class="margin462"></div>

				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
				<div class="triangle-up"></div>
			</div>

			<div class="block" id="block11" style="left: 185px; top: -300px"></div>
			<div class="block" id="block12" style="left: 185px;"></div>
			<div class="block" id="block21" style="left: 365px; top: -300px"></div>
			<div class="block" id="block22" style="left: 365px;"></div>
			<div class="block" id="block31" style="left: 545px; top: -300px"></div>
			<div class="block" id="block32" style="left: 545px;"></div>

			<div class="popup" id="popup">
				<div class="button" id="start">START</div>
				<br>
				<div class="button" id="bestScore">BEST SCORE: 0</div>
			</div>
		</div>

		<div class="score" id="score">SCORE: 0</div>
	</div>

	<script type="text/javascript">
		let popupEnable = false;
		let reverse = false;
		let keyPress = false;
		let clickCount = 0;
		let bestScore = 0;
		let score = 0;
		let width = 350;
		let minAreaBetweenBlocks = 500;
		let maxHeightBlock = 300;
		let stage = [0, 1, 3, 5, 10, 15, 20];
		showHidePopup();

		start.onclick = function(event) { startClick(event) };
		field.onclick = function(event) { clickFly(event) };

		start.ontouchstart = function(event) { startClick(event) };
		field.ontouchstart = function(event) { clickFly(event) };

		document.addEventListener('keydown', keyDown);
		document.addEventListener('keyup', function() { keyPress = false });

		function keyDown(event) {
			if (keyPress) return;
			if (event.keyCode === 32) {
				keyPress = true;
				return popupEnable ? startClick(event) : clickFly(event);
			}
		}

		function showPage() {
			document.getElementById("loader").style.display = "none";
			document.getElementById("index").style.display = "block";
		}

		function startClick(event) {
			score = 0;
			reverse = false;
			let height = field.clientHeight - bird.clientHeight;
			bird.style.transform = 'scale(1, 1)';
			let currentClick = ++clickCount;
			setScore();
			showHidePopup();

			animate({
				duration: 2000,
				timing: makeEaseOut(bounce),
				draw: function(progress) {
					if (popupEnable || currentClick !== clickCount) return;

					let top = height * progress;
					if (top >= 420) showHidePopup();

					bird.style.top = top + 'px';
				}
			});

			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					if (popupEnable || currentClick !== clickCount) return;

					bird.style.left = width * progress + "px";
				}
			});
		}

		function clickFly(event) {
			if (popupEnable) return;

			let startTop = Number.parseInt(bird.style.top.substring(0,  bird.style.left.length - 2));
			let startLeft = Number.parseInt(bird.style.left.substring(0,  bird.style.left.length - 2));
			let height = field.clientHeight - bird.clientHeight;
			let currentClick = ++clickCount;

			animate({
				duration: 1000,
				timing: makeInOut(jump),
				draw: function(progress) {
					if (popupEnable || currentClick !== clickCount) return;
					let top = startTop + height * progress;

					if ((top >= 420 || top <= 10) && !popupEnable) showHidePopup();

					bird.style.top = (top > 420 ? 420 : (top < 10 ? 10 : top)) + 'px';
				}
			});

			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					if (popupEnable || currentClick !== clickCount) return;
					if (progress < 0) progress = 0;

					let left = startLeft + width * progress * (reverse === true ? -1 : 1);

					if (left > 750 || left < 0) {
						reverse = !reverse;
						left = left > 750 ? 750 : (left < 0 ? 0 : left);
						startLeft = left + (left - startLeft);
						++score;
						setScore();
					}
					//console.log(block22.style.top.substr(0, 3));

					bird.style.transform = 'scale(' + (reverse ? -1 : 1) + ', 1)';
					bird.style.left = left + "px";
				}
			});
		}

		function showHidePopup() {
			if (clickCount > 0) document.getElementById('start').innerHTML = 'RESTART';

			popupEnable = !popupEnable;
			popup.style.opacity = (popup.style.opacity == 1 ? 0 : 1);
			popup.style.zIndex = (popup.style.zIndex == 1000 ? -1 : 1000);
		}

		function setScore() {
			if (score > bestScore) bestScore = score;

			document.getElementById('score').innerHTML = 'SCORE: ' + score;
			document.getElementById('bestScore').innerHTML = 'BEST SCORE: ' + bestScore;
			setStage();
		}
		
		function setStage() {
			let styleTop = 0;
			if (score >= 0 && score <2) {
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block11.style.top = '-300px';
				block12.style.top = '500px';
				block21.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block22.style.top = styleTop + 'px';
				block31.style.top = '-300px';
				block32.style.top = '500px';
			}
			if (score >= 2 && score <3) {
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block21.style.top = '-300px';
				block22.style.top = '500px';
				block31.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block32.style.top = styleTop + 'px';
			}
			if (score >= 3 && score <6) {
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block11.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block12.style.top = styleTop + 'px';
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block31.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block32.style.top = styleTop + 'px';
			}
			if (score >= 6) {
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block11.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block12.style.top = styleTop + 'px';
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block21.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block22.style.top = styleTop + 'px';
				styleTop = Math.floor(Math.random() * (450 - 250)) + 250;
				block31.style.top = (styleTop - minAreaBetweenBlocks) + 'px';
				block32.style.top = styleTop + 'px';
			}
		}
		
		function jump(timeFraction) {
			return  Math.pow(timeFraction*1.2, 2) * (2.2 * (timeFraction + 0.1) - 1.8)
		}
		
		function makeInOut(timing) {
			return function(timeFraction) {
				return timing(timeFraction);
			}
		}
		
		function makeEaseOut(timing) {
			return function(timeFraction) {
				return 1 - timing(1 - timeFraction);
			}
		}

		function bounce(timeFraction) {
			for (let a = 0, b = 1, result; 1; a += b, b /= 2) {
				if (timeFraction >= (7 - 4 * a) / 11) {
					return -Math.pow((11 - 6 * a - 11 * timeFraction) / 4, 2) + Math.pow(b, 2)
				}
			}
		}
		
		function quad(timeFraction) {
			return timeFraction;
		}
		
		function animate(options) {
			let start = performance.now();

			requestAnimationFrame(function animate(time) {
				let timeFraction = (time - start) / options.duration;
				if (timeFraction > 1) timeFraction = 1;

				let progress = options.timing(timeFraction);
				options.draw(progress);

				if (timeFraction < 1) requestAnimationFrame(animate);
			});
		}
	</script>
</body>
</html>