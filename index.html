<!DOCTYPE html>
<html>
<head>
	<title>Flappy Bird</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="img/favicon.ico">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>
<body>
	<div style="width: 805px; height: 482px; margin: 0 auto; border: 2px solid black; position: relative; cursor: pointer" id="field" class="unselectable">
		<img src="http://www.iconarchive.com/download/i59182/femfoyou/angry-birds/angry-bird-yellow.ico" style="position: absolute; width: 50px; height: 50px" id="bird">
	</div>
	
	<p style="text-align: center;" class="unselectable">
		<span style="padding: 5px 10px; background-color: green; color: white; cursor: pointer" id="start">start</span>
	</p>
	
	
	<script type="text/javascript">
		var reverse = false;
		var indexClick = 0;

		start.onclick = function() {
			var height = field.clientHeight - bird.clientHeight;
			var width = 300;
			var reverse = false;

			animate({
				duration: 2000,
				timing: makeEaseOut(bounce),
				draw: function(progress) {
					bird.style.top = height * progress + 'px'
				}
			});

			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					bird.style.left = width * progress + "px"
				}
			});
		}
		
		field.onclick = function() {
			var click = true;
			++indexClick;
			var startTop = Number.parseInt(bird.style.top.substring(0,  bird.style.left.length - 2));
			var startLeft = Number.parseInt(bird.style.left.substring(0,  bird.style.left.length - 2));
			let startIndex = indexClick;
			var progToReverse = 0;
			
			var height = field.clientHeight - bird.clientHeight;
			var width = 300;
			
			animate({
				duration: 1000,
				timing: makeInOut(jump),
				draw: function(progress) {
					let top = startTop + height * progress;
					bird.style.top = (top > 435 ? 435 : (top < 0 ? 0 : top)) + 'px'
				}
			});
			
			animate({
				duration: 2000,
				timing: makeEaseOut(quad),
				draw: function(progress) {
					if (indexClick != startIndex) return;
					let left = startLeft + (!click ? progToReverse : 0) + (reverse ? -width*progress : width*progress);
					console.log(left, reverse);
					if (left > 755 || left < 0) {
						reverse = !reverse;
						click = false;
						progToReverse = reverse ? width*progress : -width*progress;
						left = left > 755 ? 755 : 0;
					}
					
					
					bird.style.left = left + "px";
				}
			});
		}
		
		function jump(timeFraction) {
			return  Math.pow(timeFraction*1.2, 2) * (2.2 * (timeFraction + 0.1) - 1.7)
		}
		
		function makeInOut(timing) {
			return function(timeFraction) {
				return timing(timeFraction);
			}
		}
		
		function makeEaseOut(timing) {
			return function(timeFraction) {
				return 1 - timing(1 - timeFraction);
			}
		}

		function bounce(timeFraction) {
			for (var a = 0, b = 1, result; 1; a += b, b /= 2) {
				if (timeFraction >= (7 - 4 * a) / 11) {
					return -Math.pow((11 - 6 * a - 11 * timeFraction) / 4, 2) + Math.pow(b, 2)
				}
			}
		}
		
		function quad(timeFraction) {
			return timeFraction;
		}
		
		function animate(options) {
			var start = performance.now();
			
			requestAnimationFrame(function animate(time) {
				// timeFraction от 0 до 1
				var timeFraction = (time - start) / options.duration;
				if (timeFraction > 1) timeFraction = 1;

				// текущее состояние анимации
				var progress = options.timing(timeFraction)

				options.draw(progress);

				if (timeFraction < 1) {
					requestAnimationFrame(animate);
				}
			});
		}
	</script>
</body>
</html>